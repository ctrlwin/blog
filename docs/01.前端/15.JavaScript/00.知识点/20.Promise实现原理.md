---
title: Promiseå®ç°åŸç†
date: 2021-05-28 10:30:08
permalink: /pages/30ff4b/
categories:
  - å‰ç«¯
  - JavaScript
  - æ–¹æ³•
tags:
  - js
---
# Promiseå®ç°åŸç†

æˆ‘ä»¬éƒ½çŸ¥é“ Js æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ä¸€äº›é«˜è€—æ—¶æ“ä½œå°±å¸¦æ¥äº†è¿›ç¨‹é˜»å¡é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJs æœ‰ä¸¤ç§ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼ï¼šåŒæ­¥æ¨¡å¼ï¼ˆSynchronousï¼‰å’Œå¼‚æ­¥æ¨¡å¼ï¼ˆAsynchronousï¼‰ã€‚

åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œåˆ›å»ºå¼‚æ­¥ä»»åŠ¡ä¸»è¦åˆ†ä¸ºå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡ä¸¤ç§ã€‚ES6 è§„èŒƒä¸­ï¼Œå®ä»»åŠ¡ï¼ˆMacrotaskï¼‰ ç§°ä¸º Taskï¼Œ å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰ ç§°ä¸º Jobsã€‚å®ä»»åŠ¡æ˜¯ç”±å®¿ä¸»ï¼ˆæµè§ˆå™¨ã€Nodeï¼‰å‘èµ·çš„ï¼Œè€Œå¾®ä»»åŠ¡ç”± JS è‡ªèº«å‘èµ·ã€‚


åŸæ–‡é“¾æ¥ï¼š[ä»ä¸€é“è®©æˆ‘å¤±çœ çš„ Promise é¢è¯•é¢˜å¼€å§‹ï¼Œæ·±å…¥åˆ†æ Promise å®ç°ç»†èŠ‚](https://juejin.cn/post/6945319439772434469#heading-5)

## Promise æ ¸å¿ƒé€»è¾‘å®ç°

åŸç”ŸğŸŒ°ï¼š

```js
const promise = new Promise((resolve, reject) => {
   resolve('success')
   reject('err')
})

promise.then(value => {
  console.log('resolve', value)
}, reason => {
  console.log('reject', reason)
})

// è¾“å‡º resolve success
```

### åŸºæœ¬åŸç†

> Promise æ˜¯ä¸€ä¸ªç±»ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªç±»çš„æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿™ä¸ªæ‰§è¡Œå™¨ä¼šç«‹å³æ‰§è¡Œ
>
> Promise ä¼šæœ‰ä¸‰ç§çŠ¶æ€
>
> - Pending ç­‰å¾…
> - Fulfilled å®Œæˆ
> - Rejected å¤±è´¥
>
> çŠ¶æ€åªèƒ½ç”± Pending --> Fulfilled æˆ–è€… Pending --> Rejectedï¼Œä¸”ä¸€ä½†å‘ç”Ÿæ”¹å˜ä¾¿ä¸å¯äºŒæ¬¡ä¿®æ”¹ï¼›
>
> Promise ä¸­ä½¿ç”¨ resolve å’Œ reject ä¸¤ä¸ªå‡½æ•°æ¥æ›´æ”¹çŠ¶æ€ï¼›
>
> then æ–¹æ³•å†…éƒ¨åšçš„äº‹æƒ…å°±æ˜¯çŠ¶æ€åˆ¤æ–­
>
> - å¦‚æœçŠ¶æ€æ˜¯æˆåŠŸï¼Œè°ƒç”¨æˆåŠŸå›è°ƒå‡½æ•°
> - å¦‚æœçŠ¶æ€æ˜¯å¤±è´¥ï¼Œè°ƒç”¨å¤±è´¥å›è°ƒå‡½æ•°

ç›´æ¥ä¸Šä»£ç ï¼š

```js
// MyPromise.js

// å…ˆå®šä¹‰ä¸‰ä¸ªå¸¸é‡è¡¨ç¤ºçŠ¶æ€
const PENDING = 'pending';
const FULFILLED = 'fulfilled';
const REJECTED = 'rejected';

// æ–°å»º MyPromise ç±»
export default class MyPromise {  // ä½¿ç”¨export defaultå‘å¤–æš´éœ²MyPromiseç±»
  constructor(executor){
    // executor æ˜¯ä¸€ä¸ªæ‰§è¡Œå™¨ï¼Œè¿›å…¥ä¼šç«‹å³æ‰§è¡Œ
    // å¹¶ä¼ å…¥resolveå’Œrejectæ–¹æ³•
    executor(this.resolve, this.reject)
  }

  // å‚¨å­˜çŠ¶æ€çš„å˜é‡ï¼Œåˆå§‹å€¼æ˜¯ pending
  status = PENDING;

  // resolveå’Œrejectä¸ºä»€ä¹ˆè¦ç”¨ç®­å¤´å‡½æ•°ï¼Ÿ
  // å¦‚æœç›´æ¥è°ƒç”¨çš„è¯ï¼Œæ™®é€šå‡½æ•°thisæŒ‡å‘çš„æ˜¯windowæˆ–è€…undefined
  // ç”¨ç®­å¤´å‡½æ•°å°±å¯ä»¥è®©thisæŒ‡å‘å½“å‰å®ä¾‹å¯¹è±¡
  // æˆåŠŸä¹‹åçš„å€¼
  value = null;
  // å¤±è´¥ä¹‹åçš„åŸå› 
  reason = null;

  // æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€
  resolve = (value) => {
    // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
    if (this.status === PENDING) {
      // çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ
      this.status = FULFILLED;
      // ä¿å­˜æˆåŠŸä¹‹åçš„å€¼
      this.value = value;
    }
  }

  // æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€
  reject = (reason) => {
    // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
    if (this.status === PENDING) {
      // çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥
      this.status = REJECTED;
      // ä¿å­˜å¤±è´¥åçš„åŸå› 
      this.reason = reason;
    }
  }

  then(onFulfilled, onRejected) {
    // åˆ¤æ–­çŠ¶æ€
    if (this.status === FULFILLED) {
      // è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›
      onFulfilled(this.value);
    } else if (this.status === REJECTED) {
      // è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›
      onRejected(this.reason);
    }
  }
}
```

### æˆ‘çš„ç†è§£

![image](/blog/images/066.png)

å·¦å›¾ä¸ºpromise é€»è¾‘ä»£ç ï¼Œå³å›¾ä¸ºå®ä¾‹åº”ç”¨ä»£ç 

é€šè¿‡executorä¼ å…¥resolveå’Œrejectæ–¹æ³•ï¼Œéšååœ¨å®ä¾‹æ–¹æ³•ä¸­è°ƒç”¨resolveæ–¹æ³•ã€‚æ­¤æ—¶`MyPromise.js`ä¸­çš„resolveæ–¹æ³•ä¼šæ‰§è¡Œï¼Œä¿®æ”¹çŠ¶æ€å¹¶ä¿å­˜ä¼ å…¥çš„å€¼ã€‚

```js
// MyPromise.js
// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€
resolve = (value) => {
    // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
    if (this.status === PENDING) {
        // çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ
        this.status = FULFILLED;
        // ä¿å­˜æˆåŠŸä¹‹åçš„å€¼
        this.value = value;
    }
}
```

éšåä¼šæ‰§è¡Œthenæ–¹æ³•ï¼Œå®ƒä¼šåˆ¤æ–­å½“å‰çŠ¶æ€æ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œå¹¶è¿”å›å€¼ã€‚éšååœ¨å®ä¾‹æ–¹æ³•ä¸­æ¥æ”¶å¹¶è¾“å‡ºã€‚

```js
// MyPromise.js
then(onFulfilled, onRejected) {
        // åˆ¤æ–­çŠ¶æ€
        if (this.status === FULFILLED) {
            // è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›
            onFulfilled(this.value);
        } else if (this.status === REJECTED) {
            // è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›
            onRejected(this.reason);
        } 
    }
```

`onFulfilled`å’Œ`onRejected`ä¿å­˜çš„æ˜¯å®ä¾‹ä¸­çš„ä»£ç å¦‚ï¼š`value{console.log(...)}`

```js
// å®ä¾‹
promise.then(value => {
  console.log('resolve', value) // è¾“å‡ºresolve success
}, reason => {
  console.log('reject', reason)
})
```

## åœ¨ Promise ä¸­åŠ å…¥å¼‚æ­¥é€»è¾‘

å…ˆçœ‹ğŸŒ°

```js
// test.js

const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 2000); 
})

promise.then(value => {
  console.log('resolve', value)
}, reason => {
  console.log('reject', reason)
})

// æ²¡æœ‰æ‰“å°ä¿¡æ¯ï¼ï¼ï¼
```

è¿™æ˜¯å› ä¸ºï¼š

>ä¸»çº¿ç¨‹ä»£ç ç«‹å³æ‰§è¡Œï¼ŒsetTimeout æ˜¯å¼‚æ­¥ä»£ç ï¼Œthen ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™åˆ¤æ–­ Promise çŠ¶æ€ï¼ŒçŠ¶æ€æ˜¯ Pendingï¼Œç„¶è€Œä¹‹å‰å¹¶æ²¡æœ‰åˆ¤æ–­ç­‰å¾…è¿™ä¸ªçŠ¶æ€

**å¯¹ä»£ç è¿›è¡Œæ”¹é€ ï¼š**

### ç¼“å­˜æˆåŠŸä¸å¤±è´¥å›è°ƒ

```js
// MyPromise.js

// åœ¨yPromise ç±»ä¸­æ–°å¢
// å­˜å‚¨æˆåŠŸå›è°ƒå‡½æ•°
onFulfilledCallback = null;
// å­˜å‚¨å¤±è´¥å›è°ƒå‡½æ•°
onRejectedCallback = null;
```

### then æ–¹æ³•ä¸­çš„ Pending çš„å¤„ç†

```js
// MyPromise.js

then(onFulfilled, onRejected) {
  // åˆ¤æ–­çŠ¶æ€
  if (this.status === FULFILLED) {
    // è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›
    onFulfilled(this.value);
  } else if (this.status === REJECTED) {
    // è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›
    onRejected(this.reason);
  } else if (this.status === PENDING) {
    // ==== æ–°å¢ ====
    // å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œæ‰€ä»¥å°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥
    // ç­‰åˆ°æ‰§è¡ŒæˆåŠŸå¤±è´¥å‡½æ•°çš„æ—¶å€™å†ä¼ é€’
    this.onFulfilledCallback = onFulfilled;
    this.onRejectedCallback = onRejected;
  }
}
```

### resolve ä¸ reject ä¸­è°ƒç”¨å›è°ƒå‡½æ•°

```js
// MyPromise.js

// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€
resolve = (value) => {
  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
  if (this.status === PENDING) {
    // çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ
    this.status = FULFILLED;
    // ä¿å­˜æˆåŠŸä¹‹åçš„å€¼
    this.value = value;
    // ==== æ–°å¢ ====
    // åˆ¤æ–­æˆåŠŸå›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è°ƒç”¨
    this.onFulfilledCallback && this.onFulfilledCallback(value);
  }
}
```

```js
// MyPromise.js
// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€
reject = (reason) => {
  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
  if (this.status === PENDING) {
    // çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥
    this.status = REJECTED;
    // ä¿å­˜å¤±è´¥åçš„åŸå› 
    this.reason = reason;
    // ==== æ–°å¢ ====
    // åˆ¤æ–­å¤±è´¥å›è°ƒæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±è°ƒç”¨
    this.onRejectedCallback && this.onRejectedCallback(reason)
  }
}
```

æœ€åå†æ‰§è¡Œä¸€ä¸‹ğŸŒ°ï¼š

```js
// test.js

const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 2000); 
})

promise.then(value => {
  console.log('resolve', value)
}, reason => {
  console.log('reject', reason)
})

// ç­‰å¾… 2så è¾“å‡º resolve success
```

### æˆ‘çš„ç†è§£

åœ¨promiseæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œä¸»çº¿ç¨‹ä»£ç ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œ`setTimeout`æ˜¯å¼‚æ­¥ä»£ç ï¼Œæ‰€ä»¥ä¼šå…ˆæ‰§è¡Œ.thenä¸­çš„ä»£ç ï¼Œè¿™æ—¶å€™`MyPromise.js`ä¸­çš„thenä¼šåˆ¤æ–­å½“å‰çŠ¶æ€ï¼Œå¦‚æœæ˜¯PENDINGåˆ™å°†.thenä¸­çš„æˆåŠŸå’Œå¤±è´¥å›è°ƒä¿å­˜å¹¶åœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œè°ƒç”¨resolveæˆ–rejectæ—¶ï¼Œè¿”å›ä¿å­˜çš„æˆåŠŸæˆ–å¤±è´¥å›è°ƒã€‚

## å®ç° then æ–¹æ³•å¤šæ¬¡è°ƒç”¨æ·»åŠ å¤šä¸ªå¤„ç†å‡½æ•°

å…ˆçœ‹ä¸€ä¸ªğŸŒ°ï¼š

```js
// test.js

const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
  setTimeout(() => {
    resolve('success')
  }, 2000); 
})

promise.then(value => {
  console.log(1)
  console.log('resolve', value)
})
 
promise.then(value => {
  console.log(2)
  console.log('resolve', value)
})

promise.then(value => {
  console.log(3)
  console.log('resolve', value)
})

// 3
// resolve success
```

ç›®å‰çš„ä»£ç åªæ‰“å°å‡ºäº†ç¬¬ä¸‰ä¸ªthençš„è°ƒç”¨ï¼ŒPromiseçš„thenæ–¹æ³•æ˜¯å¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨çš„ã€‚è¿™é‡Œæœ‰ä¸‰ä¸ªthençš„è°ƒç”¨ï¼Œå¦‚æœæ˜¯åŒæ­¥å›è°ƒï¼Œé‚£ä¹ˆç›´æ¥è¿”å›å½“å‰å€¼ï¼›å¦‚æœæ˜¯å¼‚æ­¥å›è°ƒï¼Œé‚£ä¹ˆä¿å­˜çš„æˆåŠŸæˆ–å¤±è´¥çš„å›è°ƒéœ€è¦ä½¿ç”¨ä¸åŒçš„å˜é‡ä¿å­˜ã€‚

### MyPromise ç±»ä¸­æ–°å¢ä¸¤ä¸ªæ•°ç»„

```js
// MyPromise.js

// å­˜å‚¨æˆåŠŸå›è°ƒå‡½æ•°
// onFulfilledCallback = null;
onFulfilledCallbacks = [];
// å­˜å‚¨å¤±è´¥å›è°ƒå‡½æ•°
// onRejectedCallback = null;
onRejectedCallbacks = [];
```

### å›è°ƒå‡½æ•°å­˜å…¥æ•°ç»„ä¸­

```js
// MyPromise.js

then(onFulfilled, onRejected) {
  // åˆ¤æ–­çŠ¶æ€
  if (this.status === FULFILLED) {
    // è°ƒç”¨æˆåŠŸå›è°ƒï¼Œå¹¶ä¸”æŠŠå€¼è¿”å›
    onFulfilled(this.value);
  } else if (this.status === REJECTED) {
    // è°ƒç”¨å¤±è´¥å›è°ƒï¼Œå¹¶ä¸”æŠŠåŸå› è¿”å›
    onRejected(this.reason);
  } else if (this.status === PENDING) {
    // ==== æ–°å¢ ====
    // å› ä¸ºä¸çŸ¥é“åé¢çŠ¶æ€çš„å˜åŒ–ï¼Œè¿™é‡Œå…ˆå°†æˆåŠŸå›è°ƒå’Œå¤±è´¥å›è°ƒå­˜å‚¨èµ·æ¥
    // ç­‰å¾…åç»­è°ƒç”¨
    this.onFulfilledCallbacks.push(onFulfilled);
    this.onRejectedCallbacks.push(onRejected);
  }
}
```

### å¾ªç¯è°ƒç”¨ æˆåŠŸå’Œå¤±è´¥å›è°ƒ

```js
// MyPromise.js

// æ›´æ”¹æˆåŠŸåçš„çŠ¶æ€
resolve = (value) => {
  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
  if (this.status === PENDING) {
    // çŠ¶æ€ä¿®æ”¹ä¸ºæˆåŠŸ
    this.status = FULFILLED;
    // ä¿å­˜æˆåŠŸä¹‹åçš„å€¼
    this.value = value;
    // ==== æ–°å¢ ====
    // resolveé‡Œé¢å°†æ‰€æœ‰æˆåŠŸçš„å›è°ƒæ‹¿å‡ºæ¥æ‰§è¡Œ
    while (this.onFulfilledCallbacks.length) {
      // Array.shift() å–å‡ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åï¼ˆï¼‰è°ƒç”¨ï¼Œshiftä¸æ˜¯çº¯å‡½æ•°ï¼Œå–å‡ºåï¼Œæ•°ç»„å°†å¤±å»è¯¥å…ƒç´ ï¼Œç›´åˆ°æ•°ç»„ä¸ºç©º
      this.onFulfilledCallbacks.shift()(value)
    }
  }
}
```

```js
// MyPromise.js

// æ›´æ”¹å¤±è´¥åçš„çŠ¶æ€
reject = (reason) => {
  // åªæœ‰çŠ¶æ€æ˜¯ç­‰å¾…ï¼Œæ‰æ‰§è¡ŒçŠ¶æ€ä¿®æ”¹
  if (this.status === PENDING) {
    // çŠ¶æ€æˆåŠŸä¸ºå¤±è´¥
    this.status = REJECTED;
    // ä¿å­˜å¤±è´¥åçš„åŸå› 
    this.reason = reason;
    // ==== æ–°å¢ ====
    // resolveé‡Œé¢å°†æ‰€æœ‰å¤±è´¥çš„å›è°ƒæ‹¿å‡ºæ¥æ‰§è¡Œ
    while (this.onRejectedCallbacks.length) {
      this.onRejectedCallbacks.shift()(reason)
    }
  }
}
```

å†æ¥æ‰§è¡Œä¸€ä¸‹ğŸŒ°ï¼š

```js
// å®Œç¾æ‰“å°æ‰€æœ‰thençš„è°ƒç”¨
1
resolve success
2
resolve success
3
resolve success
```

## å®ç°thenæ–¹æ³•çš„é“¾å¼è°ƒç”¨

> then æ–¹æ³•è¦é“¾å¼è°ƒç”¨é‚£ä¹ˆå°±éœ€è¦è¿”å›ä¸€ä¸ª Promise å¯¹è±¡
> then æ–¹æ³•é‡Œé¢ return ä¸€ä¸ªè¿”å›å€¼ä½œä¸ºä¸‹ä¸€ä¸ª then æ–¹æ³•çš„å‚æ•°ï¼Œå¦‚æœæ˜¯ return ä¸€ä¸ª Promise å¯¹è±¡ï¼Œé‚£ä¹ˆå°±éœ€è¦åˆ¤æ–­å®ƒçš„çŠ¶æ€

ä¸¾ä¸ªğŸŒ°ï¼š

``` js
// test.js

const MyPromise = require('./MyPromise')
const promise = new MyPromise((resolve, reject) => {
  // ç›®å‰è¿™é‡Œåªå¤„ç†åŒæ­¥çš„é—®é¢˜
  resolve('success')
})

function other () {
  return new MyPromise((resolve, reject) =>{
    resolve('other')
  })
}
promise.then(value => {
  console.log(1)
  console.log('resolve', value)
  return other()
}).then(value => {
  console.log(2)
  console.log('resolve', value)
})
```

ç”¨ç›®å‰çš„æ‰‹å†™ä»£ç ä¼šæŠ¥é”™ï¼Œæ— æ³•é“¾å¼è°ƒç”¨

ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼š

``` js
// MyPromise.js

class MyPromise {
  ......
  then(onFulfilled, onRejected) {
    // ==== æ–°å¢ ====
    // ä¸ºäº†é“¾å¼è°ƒç”¨è¿™é‡Œç›´æ¥åˆ›å»ºä¸€ä¸ª MyPromiseï¼Œå¹¶åœ¨åé¢ return å‡ºå»
    const promise2 = new MyPromise((resolve, reject) => {
      // è¿™é‡Œçš„å†…å®¹åœ¨æ‰§è¡Œå™¨ä¸­ï¼Œä¼šç«‹å³æ‰§è¡Œ
      if (this.status === FULFILLED) {
        // è·å–æˆåŠŸå›è°ƒå‡½æ•°çš„æ‰§è¡Œç»“æœ
        const x = onFulfilled(this.value);
        // ä¼ å…¥ resolvePromise é›†ä¸­å¤„ç†
        resolvePromise(x, resolve, reject);
      } else if (this.status === REJECTED) {
        onRejected(this.reason);
      } else if (this.status === PENDING) {
        this.onFulfilledCallbacks.push(onFulfilled);
        this.onRejectedCallbacks.push(onRejected);
      }
    }) 
    
    return promise2;
  }
}

function resolvePromise(x, resolve, reject) {
  // åˆ¤æ–­xæ˜¯ä¸æ˜¯ MyPromise å®ä¾‹å¯¹è±¡
  if(x instanceof MyPromise) {
    // æ‰§è¡Œ xï¼Œè°ƒç”¨ then æ–¹æ³•ï¼Œç›®çš„æ˜¯å°†å…¶çŠ¶æ€å˜ä¸º fulfilled æˆ–è€… rejected
    // x.then(value => resolve(value), reason => reject(reason))
    // ç®€åŒ–ä¹‹å
    x.then(resolve, reject)
  } else{
    // æ™®é€šå€¼
    resolve(x)
  }
}
```

æ‰§è¡Œåçš„ç»“æœï¼š

```js
1
resolve success
2
resolve other
```

